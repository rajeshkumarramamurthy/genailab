apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}
  namespace: {{ .Release.Name }}
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      name: {{ .Release.Name }}
  template:
    metadata:
      labels:
        name: {{ .Release.Name }}
    spec:
      containers:
      - name: {{ .Release.Name }}
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag}}"
        securityContext:
          capabilities:
            add: ["SYS_NICE"]   
        env:
          - name: PT_HPU_ENABLE_LAZY_COLLECTIVES
            value: "true"
          - name: OMPI_MCA_btl_vader_single_copy_mechanism
            value: none
          - name: MODEL_ID
            value: {{ .Values.modelName }}
          - name: PORT 
            value: "{{ .Values.service.port }}"
          - name: HUGGINGFACE_HUB_CACHE 
            value: /models-cache
          - name: QUEUE_THRESHOLD_MS 
            value: "60"
          - name: TGI_PROFILER_ENABLED 
            value: "true"    
          {{- if .Values.shard.sharded }} 
          - name: NUM_SHARD 
            value: "{{ .Values.shard.numshard }}"
          - name: SHARDED 
            value: "true"   
          {{- end }}     
          {{- if .Values.hgtoken.tokenRequired }}           
          - name: HUGGING_FACE_HUB_TOKEN 
            value: "{{ .Values.hgtoken.token }}"
          {{- end }}
        resources:
          limits:
            habana.ai/gaudi: {{ .Values.resources.numofgaudi }}
            hugepages-2Mi: {{ .Values.resources.hugepages2Mi }}
            memory: {{ .Values.resources.memory }}
            #cpu: {{ .Values.resources.cpu }}
        volumeMounts:
          - name: models-cache
            mountPath: models-cache
      volumes:
        - name: models-cache
          hostPath:
            path: {{ .Values.hostVolumePath }}
            type: Directory